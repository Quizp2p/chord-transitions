"use strict";angular.module("d3-chord",[]).directive("d3Chord",["$window","matrixFactory",function(t,e){var r=["#52c3f1","#f77b6b","#e3d64a","#6767da","#68d4b2","#369d97","#74d9ed","#f8a13f","#dae342","#8d7be3","#a4e59b","#54becc"],n=function(n,a,o){function i(t){function e(t){d3.event.preventDefault(),d3.event.stopPropagation();var e=n.config;e.callback&&e.callback.groupClick&&(e.callback.groupClick(t),n.$$phase||n.$root.$$phase||n.$apply()),o()}function r(t){d3.event.preventDefault(),d3.event.stopPropagation(),i(t),c.css("opacity",1);var e=n.config;if(e.tooltip.formatter){var r=e.tooltip.formatter(h.read(t));c.css({left:d3.event.offsetX+20,top:d3.event.offsetY+20}).html(r)}}function a(){d3.event.preventDefault(),d3.event.stopPropagation(),c.css("opacity",0),o()}function o(){d3.event.preventDefault(),d3.event.stopPropagation(),y.selectAll("path.chord").style("opacity",.9)}function i(t){d3.event.preventDefault(),d3.event.stopPropagation(),y.selectAll("path.chord").style("opacity",function(e){return t.source?e._id===t._id?.9:.1:e.source._id===t._id||e.target._id===t._id?.9:.1})}x.attr("opacity",1),x.transition().duration(1e3).attr("opacity",0),h.data(t).resetKeys().addKeys(["node1","node2"]).update();var d=y.selectAll("g.group").data(h.groups(),function(t){return t._id}),u=d.enter().append("g").attr("class","group");u.append("path").on("click",e).on("mouseover",i).on("mouseout",o).style("fill",function(t){return f(t._id)}).attr("d",m),u.append("text").style("pointer-events","none").style("font-size","9px").attr("dy",".35em").text(function(t){return t._id}),d.select("path").transition().duration(2e3).attrTween("d",h.groupTween(m)),d.select("text").transition().duration(2e3).attr("transform",function(t){t.angle=(t.startAngle+t.endAngle)/2;var e="rotate("+(180*t.angle/Math.PI-90)+")",r=" translate("+(v+26)+")";return e+r+(t.angle>Math.PI?" rotate(180)":" rotate(0)")}).attr("text-anchor",function(t){return t.angle>Math.PI?"end":"begin"}),d.exit().select("text").attr("fill","orange"),d.exit().select("path").remove(),d.exit().transition().duration(1e3).style("opacity",0).remove();var s=y.selectAll("path.chord").data(h.chords(),function(t){return t._id});s.enter().append("path").attr("class","chord").style("fill",function(t){return f(t.source._id)}).attr("d",_).on("mouseover",r).on("mouseout",a),s.transition().duration(2e3).attrTween("d",h.chordTween(_)),s.exit().remove()}function d(){var t=[],e=n.dimension,r=void 0,a=void 0,o=[1,1];e&&(o=e.split(":").reverse().map(Number));var i=s[0].clientWidth;return i<10?(r=1200,a=800):(r=i,a=r*o[0]/o[1]),t[0]=r-l[1]-l[3],t[1]=a-l[0]-l[2],{width:r,height:a,dims:t}}function u(){g=d(),A.attr({width:g.width,height:g.height})}n.id="d3-"+n.$id;var s=a,c=s.find(".tooltip"),l=[50,50,50,50],g=d(),f=d3.scale.ordinal().range(r),p=d3.layout.chord().padding(.02).sortGroups(d3.descending).sortSubgroups(d3.ascending),h=e.chordMatrix().layout(p).filter(function(t,e,r){return t.node1===e.name&&t.node2===r.name||t.node1===r.name&&t.node2===e.name}).reduce(function(t,e,r){var n;return n=t[0]?t.reduce(function(t,n){return e===r?t+(n.weight1+n.weight2):t+(n.node1===e.name?n.weight1:n.weight2)},0):0,{value:n,data:t}}),v=g.dims[1]/2-100,m=d3.svg.arc().innerRadius(v).outerRadius(v+20),_=d3.svg.chord().radius(v),A=d3.select(s[0]).append("svg").attr("class","chart").attr({width:g.width+"px",height:g.height+"px"}).attr("preserveAspectRatio","xMinYMin").attr("viewBox","0 0 "+g.width+" "+g.height),y=A.append("g").attr("class","g-container").attr("transform","translate("+(g.dims[0]/2+l[3])+","+(g.dims[1]/2+l[0])+")"),x=A.append("text").attr("class","messages").attr("transform","translate(10, 10)").text("loading...");n.$watch("config.data",function(t,e){i(t)}),u(),t.addEventListener("resize",function(){u()})};return{restrict:"EA",template:"<div id='{{id}}' class='d3-container'><div class='tooltip'></div>",replace:!0,scope:{config:"=",dimension:"="},link:n}}]).factory("matrixFactory",[function(){var t=function(){function t(t){var e=d[t.source.index],r=d[t.target.index];return e<r?e+"__"+r:r+"__"+e}var e,r,n=[],a=[],o={},i=[],d=[],u={},s=function(){},c=function(){},l={};return l.update=function(){n=[],a=[],o={},r={groups:{},chords:{}},this.groups().forEach(function(t){r.groups[t._id]={startAngle:t.startAngle,endAngle:t.endAngle}}),this.chords().forEach(function(e){r.chords[t(e)]={source:{_id:e.source._id,startAngle:e.source.startAngle,endAngle:e.source.endAngle},target:{_id:e.target._id,startAngle:e.target.startAngle,endAngle:e.target.endAngle}}}),d=Object.keys(u);for(var l=0;l<d.length;l++){n[l]||(n[l]=[]);for(var g=0;g<d.length;g++)a=i.filter(function(t){return s(t,u[d[l]],u[d[g]])}),o=c(a,u[d[l]],u[d[g]]),o.valueOf=function(){return+this.value},n[l][g]=o}return e.matrix(n),n},l.data=function(t){return i=t,this},l.filter=function(t){return s=t,this},l.reduce=function(t){return c=t,this},l.layout=function(t){return e=t,this},l.groups=function(){return e.groups().map(function(t){return t._id=d[t.index],t})},l.chords=function(){return e.chords().map(function(e){return e._id=t(e),e.source._id=d[e.source.index],e.target._id=d[e.target.index],e})},l.addKey=function(t,e){u[t]||(u[t]={name:t,data:e||{}})},l.addKeys=function(t,e){for(var r=0;r<i.length;r++)for(var n=0;n<t.length;n++)this.addKey(i[r][t[n]],e?e(i[r],t[n]):{});return this},l.resetKeys=function(){return u={},this},l.groupTween=function(t){return function(e,n){var a,o=r.groups[e._id];return a=o?d3.interpolateObject(o,e):d3.interpolateObject({startAngle:e.startAngle,endAngle:e.startAngle},e),function(e){return t(a(e))}}},l.chordTween=function(t){return function(e,n){var a,o,i=r.chords[e._id];if(i)e.source._id!==i.source._id&&(i={source:i.target,target:i.source}),a=d3.interpolateObject(i,e);else{if(r.groups){o=[];for(var d in r.groups)i=r.groups[d],i._id!==e.source._id&&i._id!==e.target._id||o.push(i);o.length>0?(i={source:o[0],target:o[1]||o[0]},e.source._id!==i.source._id&&(i={source:i.target,target:i.source})):i=e}else i=e;a=d3.interpolateObject({source:{startAngle:i.source.startAngle,endAngle:i.source.startAngle},target:{startAngle:i.target.startAngle,endAngle:i.target.startAngle}},e)}return function(e){return t(a(e))}}},l.read=function(t){var e,r={};return t.source?(r.sname=t.source._id,r.sdata=t.source.value,r.svalue=+t.source.value,r.stotal=n[t.source.index].reduce(function(t,e){return t+e},0),r.tname=t.target._id,r.tdata=t.target.value,r.tvalue=+t.target.value,r.ttotal=n[t.target.index].reduce(function(t,e){return t+e},0)):(e=u[t._id],r.gname=e.name,r.gdata=e.data,r.gvalue=t.value),r.mtotal=n.reduce(function(t,e){return t+e.reduce(function(t,e){return t+e},0)},0),r},l};return{chordMatrix:t}}]);
//# sourceMappingURL=d3-chord.min.js.map
