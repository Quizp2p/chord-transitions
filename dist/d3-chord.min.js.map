{"version":3,"sources":["chordDirective.js"],"names":["angular","module","directive","$window","matrixFactory","colorPalette","link","$scope","$el","$attr","draw","data","groupClick","d","d3","event","preventDefault","stopPropagation","config","callback","$$phase","$root","$apply","resetChords","chordMouseover","dimChords","$tooltip","css","tooltip","formatter","info","matrix","read","left","offsetX","top","offsetY","html","hideTooltip","gContainer","selectAll","style","p","source","_id","target","messages","attr","transition","duration","resetKeys","addKeys","update","groups","gEnter","enter","append","on","colors","arc","text","select","attrTween","groupTween","angle","startAngle","endAngle","r","Math","PI","t","innerRadius","exit","remove","chords","path","chordTween","getSize","dims","dimension","width","height","ratio","split","reverse","map","Number","clientWidth","$container","marg","resize","size","svg","id","$id","find","scale","ordinal","range","chord","layout","padding","sortGroups","descending","sortSubgroups","ascending","chordMatrix","filter","item","c","node1","name","node2","reduce","items","value","m","n","weight1","weight2","outerRadius","radius","$watch","current","prev","addEventListener","restrict","template","replace","scope","factory","chordID","s","matrixIndex","index","chordLayout","layoutCache","_matrix","objs","entry","dataStore","indexHash","this","forEach","group","Object","keys","i","length","j","obj","valueOf","func","d3_chordLayout","addKey","key","props","fun","d3_arc","tween","cached","interpolateObject","d3_path","push","g","sname","sdata","svalue","stotal","k","tname","tdata","tvalue","ttotal","gname","gdata","gvalue","mtotal","m1","n1","m2","n2"],"mappings":"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","file":"d3-chord.min.js","sourcesContent":["angular.module('d3-chord', []).directive('d3Chord', ['$window', 'matrixFactory', function ($window, matrixFactory) {\n    let colorPalette=[\n        \"#52c3f1\", \"#f77b6b\", \"#e3d64a\", \"#6767da\", \"#68d4b2\", \"#369d97\",\n        \"#74d9ed\", \"#f8a13f\", \"#dae342\", \"#8d7be3\", \"#a4e59b\", \"#54becc\"\n    ];\n    var link = function ($scope, $el, $attr) {\n\t\t$scope.id = \"d3-\" + $scope.$id;\n\t\tlet $container = $el, $tooltip = $container.find(\".tooltip\");\n\t\tlet marg = [50, 50, 50, 50]; // TOP, RIGHT, BOTTOM, LEFT\n\t\tlet size = getSize();\n        let colors = d3.scale.ordinal()\n            .range(colorPalette);\n\n        let chord = d3.layout.chord()\n            .padding(0.02)\n            .sortGroups(d3.descending)\n            .sortSubgroups(d3.ascending);\n        let matrix = matrixFactory.chordMatrix()\n            .layout(chord)\n            .filter(function (item, r, c) {\n                return (item.node1 === r.name && item.node2 === c.name) ||\n                    (item.node1 === c.name && item.node2 === r.name);\n            })\n            .reduce(function (items, r, c) {\n                var value;\n                if (!items[0]) {\n                    value = 0;\n                } else {\n                    value = items.reduce(function (m, n) {\n                        if (r === c) {\n                            return m + (n.weight1 + n.weight2);\n                        } else {\n                            return m + (n.node1 === r.name ? n.weight1 : n.weight2);\n                        }\n                    }, 0);\n                }\n                return {value: value, data: items};\n            });\n\n        let innerRadius = (size.dims[1] / 2) - 100;\n\n        let arc = d3.svg.arc()\n            .innerRadius(innerRadius)\n            .outerRadius(innerRadius + 20);\n\n        let path = d3.svg.chord()\n            .radius(innerRadius);\n\n\n        let svg = d3.select($container[0]).append(\"svg\")\n            .attr(\"class\", \"chart\")\n            .attr({width: size.width + \"px\", height: size.height + \"px\"})\n            .attr(\"preserveAspectRatio\", \"xMinYMin\")\n            .attr(\"viewBox\", \"0 0 \" + size.width + \" \" + size.height);\n\n        let gContainer = svg.append(\"g\")\n            .attr(\"class\", \"g-container\")\n            .attr(\"transform\", \"translate(\" + ((size.dims[0] / 2) + marg[3]) + \",\" + ((size.dims[1] / 2) + marg[0]) + \")\");\n        let messages = svg.append(\"text\")\n            .attr(\"class\", \"messages\")\n            .attr(\"transform\", \"translate(10, 10)\")\n            .text(\"loading...\");\n\n        //绘制图形\n        function draw(data) {\n            messages.attr(\"opacity\", 1);\n            messages.transition().duration(1000).attr(\"opacity\", 0);\n            matrix.data(data)\n                .resetKeys()\n                .addKeys(['node1', 'node2'])\n                .update();\n            let groups = gContainer.selectAll(\"g.group\")\n                .data(matrix.groups(), function (d) {\n                    return d._id;\n                });\n\n            let gEnter = groups.enter()\n                .append(\"g\")\n                .attr(\"class\", \"group\");\n\n            gEnter.append(\"path\")\n                .on(\"click\", groupClick)\n                .on(\"mouseover\", dimChords)\n                .on(\"mouseout\", resetChords)\n                .style(\"fill\", function (d) {\n                    return colors(d._id);\n                })\n                .attr(\"d\", arc);\n\n            gEnter.append(\"text\")\n                .style(\"pointer-events\", \"none\")\n                .style(\"font-size\", \"9px\")\n                .attr(\"dy\", \".35em\")\n                .text(function (d) {\n                    return d._id;\n                });\n\n            groups.select(\"path\")\n                .transition().duration(2000)\n                .attrTween(\"d\", matrix.groupTween(arc));\n\n            groups.select(\"text\")\n                .transition()\n                .duration(2000)\n                .attr(\"transform\", function (d) {\n                    d.angle = (d.startAngle + d.endAngle) / 2;\n                    var r = \"rotate(\" + (d.angle * 180 / Math.PI - 90) + \")\";\n                    var t = \" translate(\" + (innerRadius + 26) + \")\";\n                    return r + t + (d.angle > Math.PI ? \" rotate(180)\" : \" rotate(0)\");\n                })\n                .attr(\"text-anchor\", function (d) {\n                    return d.angle > Math.PI ? \"end\" : \"begin\";\n                });\n\n            groups.exit().select(\"text\").attr(\"fill\", \"orange\");\n            groups.exit().select(\"path\").remove();\n\n            groups.exit().transition().duration(1000)\n                .style(\"opacity\", 0).remove();\n\n            let chords = gContainer.selectAll(\"path.chord\")\n                .data(matrix.chords(), function (d) {\n                    return d._id;\n                });\n\n            chords.enter().append(\"path\")\n                .attr(\"class\", \"chord\")\n                .style(\"fill\", function (d) {\n                    return colors(d.source._id);\n                })\n                .attr(\"d\", path)\n                .on(\"mouseover\", chordMouseover)\n                .on(\"mouseout\", hideTooltip);\n\n            chords.transition().duration(2000)\n                .attrTween(\"d\", matrix.chordTween(path));\n\n            chords.exit().remove();\n            //点击事件\n            function groupClick(d) {\n                d3.event.preventDefault();\n                d3.event.stopPropagation();\n                let config = $scope.config;\n                if (config.callback && config.callback.groupClick) {\n                    config.callback.groupClick(d);\n                    if(!$scope.$$phase && !$scope.$root.$$phase) $scope.$apply();\n                }\n                resetChords();\n            }\n\n            //鼠标飘过事件\n            function chordMouseover(d) {\n                d3.event.preventDefault();\n                d3.event.stopPropagation();\n                dimChords(d);\n                $tooltip.css(\"opacity\", 1);\n                let config = $scope.config;\n                if (config.tooltip.formatter) {\n                    let info = config.tooltip.formatter(matrix.read(d));\n                    $tooltip.css({left:d3.event.offsetX+20,top:d3.event.offsetY+20}).html(info);\n                }\n            }\n\n            //隐藏tooltip\n            function hideTooltip() {\n                d3.event.preventDefault();\n                d3.event.stopPropagation();\n                $tooltip.css(\"opacity\", 0);\n                resetChords();\n            }\n\n            //重置\n            function resetChords() {\n                d3.event.preventDefault();\n                d3.event.stopPropagation();\n                gContainer.selectAll(\"path.chord\").style(\"opacity\", 0.9);\n            }\n\n            function dimChords(d) {\n                d3.event.preventDefault();\n                d3.event.stopPropagation();\n                gContainer.selectAll(\"path.chord\").style(\"opacity\", function (p) {\n                    if (d.source) { // COMPARE CHORD IDS\n                        return (p._id === d._id) ? 0.9 : 0.1;\n                    } else { // COMPARE GROUP IDS\n                        return (p.source._id === d._id || p.target._id === d._id) ? 0.9 : 0.1;\n                    }\n                });\n            }\n        }\n\n        $scope.$watch(\"config.data\", function (current, prev) {\n\t\t\tdraw(current);\n        });\n\t\tfunction getSize() {\n\t\t\tlet dims = []; // USABLE DIMENSIONS\n\t\t\tlet dimension = $scope.dimension;\n\t\t\tlet width, height,ratio=[1,1];\n\t\t\tif(dimension){\n\t\t\t\tratio = dimension.split(\":\").reverse().map(Number);\n\t\t\t}\n\t\t\tlet clientWidth = $container[0].clientWidth;\n\t\t\tif(clientWidth<10){\n\t\t\t\twidth=1200;\n\t\t\t\theight=800;\n\t\t\t}else{\n\t\t\t\twidth = clientWidth;\n\t\t\t\theight = width * ratio[0] / ratio[1];\n\t\t\t}\n\t\t\tdims[0] = width - marg[1] - marg[3]; // WIDTH\n\t\t\tdims[1] = height - marg[0] - marg[2]; // HEIGHT\n\t\t\treturn {width,height,dims};\n\t\t}\n        function resize() {\n            size = getSize();\n            svg.attr({\n                width: size.width,\n                height: size.height\n            });\n        }\n\n        resize();\n        $window.addEventListener(\"resize\", function () {\n            resize();\n        });\n    };\n\n    return {\n        restrict: 'EA',\n        template: \"<div id='{{id}}' class='d3-container'><div class='tooltip'></div>\",\n        replace: true,\n        scope: {\n            config: \"=\",\n\t\t\tdimension:\"=\"\n        },\n        link: link\n    };\n}]).factory('matrixFactory', [function () {\n\n    var chordMatrix = function () {\n\n        var _matrix = [],objs=[],entry={}, dataStore = [], _id = 0;\n        var matrixIndex = [], indexHash = {};\n        var chordLayout, layoutCache;\n\n        var filter = function () {};\n        var reduce = function () {};\n\n        var matrix = {};\n\n        matrix.update = function () {\n            _matrix = [], objs = [], entry = {};\n\n            layoutCache = {groups: {}, chords: {}};\n\n            this.groups().forEach(function (group) {\n                layoutCache.groups[group._id] = {\n                    startAngle: group.startAngle,\n                    endAngle: group.endAngle\n                };\n            });\n\n            this.chords().forEach(function (chord) {\n                layoutCache.chords[chordID(chord)] = {\n                    source: {\n                        _id: chord.source._id,\n                        startAngle: chord.source.startAngle,\n                        endAngle: chord.source.endAngle\n                    },\n                    target: {\n                        _id: chord.target._id,\n                        startAngle: chord.target.startAngle,\n                        endAngle: chord.target.endAngle\n                    }\n                };\n            });\n\n            matrixIndex = Object.keys(indexHash);\n\n            for (var i = 0; i < matrixIndex.length; i++) {\n                if (!_matrix[i]) {\n                    _matrix[i] = [];\n                }\n                for (var j = 0; j < matrixIndex.length; j++) {\n                    objs = dataStore.filter(function (obj) {\n                        return filter(obj, indexHash[matrixIndex[i]], indexHash[matrixIndex[j]]);\n                    });\n                    entry = reduce(objs, indexHash[matrixIndex[i]], indexHash[matrixIndex[j]]);\n                    entry.valueOf = function () { return +this.value };\n                    _matrix[i][j] = entry;\n                }\n            }\n            chordLayout.matrix(_matrix);\n            return _matrix;\n        };\n\n        matrix.data = function (data) {\n            dataStore = data;\n            return this;\n        };\n\n        matrix.filter = function (func) {\n            filter = func;\n            return this;\n        };\n\n        matrix.reduce = function (func) {\n            reduce = func;\n            return this;\n        };\n\n        matrix.layout = function (d3_chordLayout) {\n            chordLayout = d3_chordLayout;\n            return this;\n        };\n\n        matrix.groups = function () {\n            return chordLayout.groups().map(function (group) {\n                group._id = matrixIndex[group.index];\n                return group;\n            });\n        };\n\n        matrix.chords = function () {\n            return chordLayout.chords().map(function (chord) {\n                chord._id = chordID(chord);\n                chord.source._id = matrixIndex[chord.source.index];\n                chord.target._id = matrixIndex[chord.target.index];\n                return chord;\n            });\n        };\n\n        matrix.addKey = function (key, data) {\n            if (!indexHash[key]) {\n                indexHash[key] = {name: key, data: data || {}};\n            }\n        };\n\n        matrix.addKeys = function (props, fun) {\n            for (var i = 0; i < dataStore.length; i++) {\n                for (var j = 0; j < props.length; j++) {\n                    this.addKey(dataStore[i][props[j]], fun ? fun(dataStore[i], props[j]):{});\n                }\n            }\n            return this;\n        };\n\n        matrix.resetKeys = function () {\n            indexHash = {};\n            return this;\n        };\n\n        function chordID(d) {\n            var s = matrixIndex[d.source.index];\n            var t = matrixIndex[d.target.index];\n            return (s < t) ? s + \"__\" + t: t + \"__\" + s;\n        }\n\n        matrix.groupTween = function (d3_arc) {\n            return function (d, i) {\n                var tween;\n                var cached = layoutCache.groups[d._id];\n\n                if (cached) {\n                    tween = d3.interpolateObject(cached, d);\n                } else {\n                    tween = d3.interpolateObject({\n                        startAngle:d.startAngle,\n                        endAngle:d.startAngle\n                    }, d);\n                }\n\n                return function (t) {\n                    return d3_arc(tween(t));\n                };\n            };\n        };\n\n        matrix.chordTween = function (d3_path) {\n            return function (d, i) {\n                var tween, groups;\n                var cached = layoutCache.chords[d._id];\n\n                if (cached) {\n                    if (d.source._id !== cached.source._id){\n                        cached = {source: cached.target, target: cached.source};\n                    }\n                    tween = d3.interpolateObject(cached, d);\n                } else {\n                    if (layoutCache.groups) {\n                        groups = [];\n                        for (var key in layoutCache.groups) {\n                            cached = layoutCache.groups[key];\n                            if (cached._id === d.source._id || cached._id === d.target._id) {\n                                groups.push(cached);\n                            }\n                        }\n                        if (groups.length > 0) {\n                            cached = {source: groups[0], target: groups[1] || groups[0]};\n                            if (d.source._id !== cached.source._id) {\n                                cached = {source: cached.target, target: cached.source};\n                            }\n                        } else {\n                            cached = d;\n                        }\n                    } else {\n                        cached = d;\n                    }\n\n                    tween = d3.interpolateObject({\n                        source: {\n                            startAngle: cached.source.startAngle,\n                            endAngle: cached.source.startAngle\n                        },\n                        target: {\n                            startAngle: cached.target.startAngle,\n                            endAngle: cached.target.startAngle\n                        }\n                    }, d);\n                }\n\n                return function (t) {\n                    return d3_path(tween(t));\n                };\n            };\n        };\n\n        matrix.read = function (d) {\n            var g, m = {};\n\n            if (d.source) {\n                m.sname  = d.source._id;\n                m.sdata  = d.source.value;\n                m.svalue = +d.source.value;\n                m.stotal = _matrix[d.source.index].reduce(function (k, n) { return k + n; }, 0);\n                m.tname  = d.target._id;\n                m.tdata  = d.target.value;\n                m.tvalue = +d.target.value;\n                m.ttotal = _matrix[d.target.index].reduce(function (k, n) { return k + n; }, 0);\n            } else {\n                g = indexHash[d._id];\n                m.gname  = g.name;\n                m.gdata  = g.data;\n                m.gvalue = d.value;\n            }\n            m.mtotal = _matrix.reduce(function (m1, n1) {\n                return m1 + n1.reduce(function (m2, n2) { return m2 + n2; }, 0);\n            }, 0);\n            return m;\n        };\n\n        return matrix;\n    };\n\n    return {\n        chordMatrix: chordMatrix\n    };\n}]);\n"],"sourceRoot":"/source/"}